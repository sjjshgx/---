<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Enhanced Radar Chart</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .radar-chart {
            width: 100%;
            height: 600px;
        }
        .radar-chart text {
            font-family: sans-serif;
            font-size: 12px;
        }
        .radar-chart line {
            stroke: #ccc;
            stroke-width: 1px;
        }
        .radar-chart polygon {
            fill-opacity: 0.3;
            stroke-width: 2px;
            transition: fill-opacity 0.2s, stroke-width 0.2s;
        }
        .mean-polygon {
            stroke: #ff6347;
            stroke-width: 3px;
            fill: none;
        }
        .mean-point {
            fill: #ff6347;
            stroke: #fff;
            stroke-width: 2px;
        }
        .axis line {
            stroke: #999;
            stroke-width: 1px;
        }
        .axis text {
            font-size: 12px;
        }
        .outer-border {
            stroke: #000;
            stroke-width: 2px;
            fill: none;
        }
        /* 图例样式 */
        .legend {
            font-size: 12px;
        }
        /* 悬停效果 */
        .polygon:hover {
            fill-opacity: 0.7;
            stroke-width: 4px;
        }
        /* 提示框样式 */
        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 6px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body>
    <div id="radar-chart" class="radar-chart"></div>

    <!-- 提示框 -->
    <div id="tooltip" class="tooltip"></div>

    <script>
        /**
         * 增强功能说明：
         * 1. 通过悬停功能显示公司的详细数据。
         * 2. 添加图例，表示不同的公司颜色。
         * 3. 鼠标悬停时高亮公司多边形，交互更加直观。
         */

        // 使用d3.csv函数读取CSV文件
        d3.csv("DataSet.csv").then(function(data) {
            const categories = Object.keys(data[0]).slice(1); // 提取指标名称
            const width = 600;
            const height = 600;
            const radius = Math.min(width, height) / 2;
            const levels = 5; // 刻度线级别
            const margin = { top: 50, right: 50, bottom: 50, left: 50 };

            const color = d3.scaleOrdinal(d3.schemeCategory10);

            // 计算每个类别的最大值用于缩放
            const maxValues = categories.reduce((acc, category) => {
                acc[category] = d3.max(data, d => +d[category]);
                return acc;
            }, {});

            const angle = (category) => (categories.indexOf(category) / categories.length) * 2 * Math.PI;
            const scaleValue = (category, value) => (value / maxValues[category]) * radius;

            // 选择SVG容器并设置尺寸
            const svg = d3.select("#radar-chart").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${width / 2 + margin.left},${height / 2 + margin.top})`);

            // 绘制刻度线
            for (let level = 0; level < levels; level++) {
                const levelFactor = (radius / levels) * (level + 1);
                svg.selectAll(".levels")
                    .data(categories)
                    .enter()
                    .append("line")
                    .attr("x1", (d, i) => levelFactor * Math.cos(angle(d) - Math.PI / 2))
                    .attr("y1", (d, i) => levelFactor * Math.sin(angle(d) - Math.PI / 2))
                    .attr("x2", (d, i) => levelFactor * Math.cos(angle(categories[i + 1] || categories[0]) - Math.PI / 2))
                    .attr("y2", (d, i) => levelFactor * Math.sin(angle(categories[i + 1] || categories[0]) - Math.PI / 2))
                    .attr("class", "line")
                    .style("stroke", "#ccc")
                    .style("stroke-opacity", 0.75)
                    .style("stroke-width", "0.5px");
            }

            // 计算每个岗位的均值
            const meanData = {};
            categories.forEach(category => {
                meanData[category] = d3.mean(data, d => +d[category]);
            });

            // 绘制均值多边形
            const meanLine = d3.lineRadial()
                .radius((d, i) => scaleValue(categories[i], meanData[categories[i]]))
                .angle((d, i) => angle(categories[i]));

            svg.append("path")
                .datum(categories.map(c => meanData[c]))
                .attr("class", "mean-polygon")
                .attr("d", meanLine);

            // 添加均值点并突出显示
            categories.forEach((category, i) => {
                svg.append("circle")
                    .attr("class", "mean-point")
                    .attr("cx", scaleValue(category, meanData[category]) * Math.cos(angle(category) - Math.PI / 2))
                    .attr("cy", scaleValue(category, meanData[category]) * Math.sin(angle(category) - Math.PI / 2))
                    .attr("r", 6)
                    .attr("fill", "#ff6347")
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 2);
            });

            // 绘制雷达图的多边形
            const line = d3.lineRadial()
                .radius((d, i) => scaleValue(categories[i], d))
                .angle((d, i) => angle(categories[i]));

            const polygon = svg.selectAll(".polygon")
                .data(data)
                .enter().append("path")
                .attr("class", "polygon")
                .attr("d", d => line(categories.map(c => +d[c])))
                .style("fill", (d, i) => color(i))
                .style("fill-opacity", 0.3)
                .style("stroke", (d, i) => color(i))
                .style("stroke-width", 2)
                .on("mouseover", function(event, d) {
                    // 鼠标悬停时显示详细数据
                    d3.select("#tooltip")
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px")
                        .style("opacity", 1)
                        .html(`公司: ${d['Company']}<br>${categories.map(c => `${c}: ${d[c]}`).join("<br>")}`);
                })
                .on("mouseout", function() {
                    d3.select("#tooltip").style("opacity", 0);  // 鼠标移出后隐藏
                });

            // 添加数据点
            categories.forEach((category, i) => {
                svg.selectAll(`.point-${i}`)
                    .data(data)
                    .enter().append("circle")
                    .attr("class", `point-${i}`)
                    .attr("cx", d => scaleValue(category, d[category]) * Math.cos(angle(category) - Math.PI / 2))
                    .attr("cy", d => scaleValue(category, d[category]) * Math.sin(angle(category) - Math.PI / 2))
                    .attr("r", 4)
                    .attr("fill", (d, j) => color(j));
            });

            // 添加轴线
            svg.selectAll(".axis")
                .data(categories)
                .enter()
                .append("g")
                .attr("class", "axis")
                .append("line")
                .attr("x1", 0)
                .attr("y1", 0)
                .attr("x2", (d, i) => radius * Math.cos(angle(d) - Math.PI / 2))
                .attr("y2", (d, i) => radius * Math.sin(angle(d) - Math.PI / 2))
                .style("stroke", "#999")
                .style("stroke-width", "1px");

            // 添加类别标签
            svg.selectAll(".axis")
                .append("text")
                .attr("class", "label")
                .attr("x", (d, i) => (radius + 20) * Math.cos(angle(d) - Math.PI / 2))
                .attr("y", (d, i) => (radius + 20) * Math.sin(angle(d) - Math.PI / 2))
                .attr("dy", "0.35em")
                .style("font-size", "12px")
                .attr("text-anchor", "middle")
                .text(d => d);

            // 添加图例
            const legend = svg.selectAll(".legend")
                .data(data)
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => `translate(0, ${i * 20})`);

            legend.append("rect")
                .attr("x", width - 18)
                .attr("width", 18)
                .attr("height", 18)
                .style("fill", (d, i) => color(i));

            legend.append("text")
                .attr("x", width - 24)
                .attr("y", 9)
                .attr("dy", ".35em")
                .style("text-anchor", "end")
                .text(d => d['Company']);  // 显示公司名称
        });
    </script>
</body>
</html>